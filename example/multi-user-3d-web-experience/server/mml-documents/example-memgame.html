<m-group id="demo-group">
  <m-group id="game-group" y="1.45"></m-group>
</m-group>

<script>
  const demoGroup = document.getElementById("demo-group");
  const gameGroup = document.getElementById("game-group");

  const columns = 4;
  const animDuration = 550;
  const colorOff = "#424242";
  const colorOn = "#eeeeee";
  const colorMatch = "#ccffcc";
  const defaultEasing = "easeInOutCubic";
  const imgPrefix = "memgame_image_";
  const numberOfAvailableImages = 21;
  const numberOfImages = 8;

  const imageScale = 1.5;
  const cubeScale = 1.6;
  const gap = 1.7;

  const blocks = new Map();

  let playButton = null;

  let availableImages = [];
  let images = [];
  let imagesDuplicated = [];

  let animating = false;
  let firstIndexSelected = null;
  let secondIndexSelected = null;

  let soundPlay = null;
  let soundYes = null;
  let soundNo = null;
  let soundWin = null;

  let isReseting = true;
  let isReset = false;
  let gameInProgress = false;
  let lastReset = document.timeline.currentTime;

  // tell me more ===================================================
  function tellMeMore(x, y, z, buttonOffset, yRotation, parentGroup) {
    const tellMeMoreGroup = document.createElement("m-group");
    tellMeMoreGroup.setAttribute("ry", yRotation);

    const duration = 120;
    const infoSoundDuration = 22000;
    let audioCanPlay = true;
    let infoAudioCanPlay = true;

    const transform = (element, x, y, z) => {
      element.setAttribute("x", x);
      element.setAttribute("y", y);
      element.setAttribute("z", z);
    };

    const sound = document.createElement("m-audio");
    sound.setAttribute("y", 1.2);
    sound.setAttribute("loop", false);
    sound.setAttribute("src", "/assets/playground/button_sfx.mp3");
    sound.setAttribute("volume", 0);
    sound.setAttribute("start-time", document.timeline.currentTime - 900);
    sound.setAttribute("pause-time", document.timeline.currentTime);
    tellMeMoreGroup.appendChild(sound);

    const infoSound = document.createElement("m-audio");
    infoSound.setAttribute("y", 1.2);
    infoSound.setAttribute("loop", false);
    infoSound.setAttribute("src", "/assets/playground/memory_game.mp3");
    infoSound.setAttribute("volume", 0);
    infoSound.setAttribute("start-time", document.timeline.currentTime - 22000);
    infoSound.setAttribute("pause-time", document.timeline.currentTime);
    tellMeMoreGroup.appendChild(infoSound);

    const playSound = () => {
      if (!audioCanPlay) {
        return;
      }
      audioCanPlay = false;

      const now = document.timeline.currentTime;
      sound.setAttribute("volume", 2);
      sound.setAttribute("start-time", now);
      sound.setAttribute("pause-time", now + 900);
      setTimeout(() => sound.setAttribute("volume", 0), 1000);

      infoSound.setAttribute("volume", 3);
      infoSound.setAttribute("start-time", now + 1000);
      infoSound.setAttribute("pause-time", now + infoSoundDuration + 1000);
      setTimeout(() => {
        infoSound.setAttribute("volume", 0);
        audioCanPlay = true;
      }, infoSoundDuration);
    };

    const animate = (element, attr, start, end, duration, easing) => {
      const anim = document.createElement("m-attr-anim");
      anim.setAttribute("attr", attr);
      anim.setAttribute("start", start);
      anim.setAttribute("end", end);
      anim.setAttribute("start-time", document.timeline.currentTime);
      anim.setAttribute("end-time", document.timeline.currentTime + duration);
      anim.setAttribute("duration", duration);
      anim.setAttribute("easing", easing);
      anim.setAttribute("loop", false);
      element.appendChild(anim);
      playSound();
      setTimeout(() => {
        element.setAttribute(attr, end);
        element.removeChild(anim);
      }, duration);
    };

    const scale = (element, size) => {
      element.setAttribute("sx", size);
      element.setAttribute("sy", size);
      element.setAttribute("sz", size);
    };

    const swap = (elementA, elementB) => {
      scale(elementB, 1.0);
      scale(elementA, 0.001);
    };

    const base = document.createElement("m-model");
    const buttonOn = document.createElement("m-model");
    const buttonOff = document.createElement("m-model");
    base.setAttribute("src", "/assets/playground/tell_me_more_base.glb");
    buttonOn.setAttribute("src", "/assets/playground/tell_me_more_question_button_on.glb");
    buttonOff.setAttribute("src", "/assets/playground/tell_me_more_question_button_off.glb");
    scale(buttonOff, 0.001);
    transform(tellMeMoreGroup, x, y, z);

    buttonOn.addEventListener("click", () => {
      animate(buttonOn, "z", 0, +buttonOffset, duration, "easeInOutCubic");
      animate(buttonOn, "y", 0, -buttonOffset, duration, "easeInOutCubic");
      setTimeout(() => {
        animate(buttonOn, "z", +buttonOffset, 0, duration, "easeInOutCubic");
        animate(buttonOn, "y", -buttonOffset, 0, duration, "easeInOutCubic");

        setTimeout(() => {
          swap(buttonOn, buttonOff);
          setTimeout(() => swap(buttonOff, buttonOn), infoSoundDuration);
        }, duration + 20);
      }, duration + 20);
    });

    tellMeMoreGroup.appendChild(buttonOn);
    tellMeMoreGroup.appendChild(buttonOff);
    tellMeMoreGroup.appendChild(base);
    parentGroup.appendChild(tellMeMoreGroup);
  }
  tellMeMore(-1, 0, 2, 0.03, 180, demoGroup);
  // ================================================================

  function setupAudioTag(element, url) {
    element.setAttribute("src", url);
    element.setAttribute("loop", false);
    element.setAttribute("volume", 0);
    element.setAttribute("start-time", document.timeline.currentTime - 1500);
    element.setAttribute("pause-time", document.timeline.currentTime);
    element.setAttribute("z", 0.5);
    element.setAttribute("x", (columns * cubeScale) / 2 - cubeScale / 2);
    element.setAttribute("y", 5);
    element.setAttribute("rx", 65);
    element.setAttribute("cone-angle", 90);
    element.setAttribute("cone-falloff-angle", 120);
    element.setAttribute("debug", false);
  }

  function createSFX() {
    soundPlay = document.createElement("m-audio");
    setupAudioTag(soundPlay, "/assets/playground/game_play.mp3");
    soundYes = document.createElement("m-audio");
    setupAudioTag(soundYes, "/assets/playground/game_yes.mp3");
    soundNo = document.createElement("m-audio");
    setupAudioTag(soundNo, "/assets/playground/game_no.mp3");
    soundWin = document.createElement("m-audio");
    setupAudioTag(soundWin, "/assets/playground/game_win.mp3");
    gameGroup.appendChild(soundPlay);
    gameGroup.appendChild(soundYes);
    gameGroup.appendChild(soundNo);
    gameGroup.appendChild(soundWin);
  }

  function playSound(sound, volume) {
    sound.setAttribute("volume", volume);
    sound.setAttribute("start-time", document.timeline.currentTime);
    sound.setAttribute("pause-time", document.timeline.currentTime + 1200);
    setTimeout(() => sound.setAttribute("volume", 0), 1200);
  }

  // :)
  function playPlay() {
    playSound(soundPlay, 4);
  }

  function playYes() {
    playSound(soundYes, 4);
  }

  function playNo() {
    playSound(soundNo, 2);
  }

  function playWin() {
    playSound(soundWin, 3);
  }

  function prepareImages() {
    availableImages = [];
    images = [];
    imagesDuplicated = [];
    for (let i = 0; i < numberOfAvailableImages; i++) {
      availableImages.push(`${imgPrefix}${i.toString().padStart(2, "0")}.jpg`);
    }
    while (images.length < numberOfImages) {
      const imageName = getRandomImage(availableImages);
      const url = `/assets/playground/${imageName}`;
      if (!images.includes(url)) {
        images.push(url);
      }
    }
    imagesDuplicated = images.concat(images);
    shuffleArray(imagesDuplicated);
  }

  function getRandomImage(arr) {
    const randomIndex = Math.floor(Math.random() * arr.length);
    return arr[randomIndex];
  }

  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  function highlightElement(element) {
    const color = element.getAttribute("color");
    const hue = parseInt(color.replace("hsl(", "").split(",")[0]);
    element.setAttribute("color", `hsl(${hue}, 90%, 50%)`);
    setTimeout(() => element.setAttribute("color", color), 160);
  }

  function createFrame() {
    const totalBlocks = numberOfImages * 2;
    const rows = Math.ceil(totalBlocks / columns);
    const frameWidth = columns * gap;
    const frameHeight = rows * gap;
    const frameGroup = document.createElement("m-group");
    const backCube = document.createElement("m-cube");
    backCube.setAttribute("color", "black");
    backCube.setAttribute("sx", frameWidth + 0.5);
    backCube.setAttribute("sy", frameHeight + 0.5);
    backCube.setAttribute("sz", 0.5);
    backCube.setAttribute("x", frameWidth / 2 - gap / 2);
    backCube.setAttribute("y", frameHeight / 2 - gap / 2);
    backCube.setAttribute("z", -0.35);
    frameGroup.appendChild(backCube);

    const playCube = document.createElement("m-cube");
    playCube.setAttribute("color", "black");
    playCube.setAttribute("sx", frameWidth + 0.5);
    playCube.setAttribute("sy", 1);
    playCube.setAttribute("sz", 0.5);
    playCube.setAttribute("x", frameWidth / 2 - gap / 2);
    playCube.setAttribute("y", -1.25);
    playCube.setAttribute("z", -0.08);
    playCube.setAttribute("rx", -45);
    frameGroup.appendChild(playCube);

    playButton = document.createElement("m-label");
    playButton.setAttribute("content", "PLAY");
    playButton.setAttribute("padding", 0);
    playButton.setAttribute("alignment", "center");
    playButton.setAttribute("color", "hsl(150, 50%, 40%)");
    playButton.setAttribute("width", 3);
    playButton.setAttribute("height", 0.45);
    playButton.setAttribute("font-size", 33);
    playButton.setAttribute("font-color", "#ffffff");
    playButton.setAttribute("x", frameWidth / 2 - gap / 2);
    playButton.setAttribute("y", -1.2);
    playButton.setAttribute("z", 0.225);
    playButton.setAttribute("rx", -45);
    playButton.addEventListener("click", () => {
      if (gameInProgress === false && isReseting === false) {
        playPlay();
        highlightElement(playButton);
        reStartGame();
      }
    });
    frameGroup.appendChild(playButton);

    gameGroup.appendChild(frameGroup);
  }

  function createBlock(index) {
    const blockMeshGroup = document.createElement("m-group");

    const column = index % columns;
    const row = Math.floor(index / columns);
    const cube = document.createElement("m-cube");
    cube.setAttribute("color", colorOff);
    cube.setAttribute("sx", cubeScale);
    cube.setAttribute("sy", cubeScale);
    cube.setAttribute("sz", 0.3334);
    cube.addEventListener("click", () => handleBlockClick(index));

    blockMeshGroup.appendChild(cube);

    const textureSrc = imagesDuplicated[index];
    const texture = document.createElement("m-image");
    texture.setAttribute("src", textureSrc);
    texture.setAttribute("z", 0.168);
    texture.setAttribute("sx", imageScale);
    texture.setAttribute("sy", imageScale);
    blockMeshGroup.appendChild(texture);

    blockMeshGroup.setAttribute("x", column * gap);
    blockMeshGroup.setAttribute("y", row * gap);
    blockMeshGroup.setAttribute("z", 0.1);
    blockMeshGroup.setAttribute("ry", 180);

    const block = {
      id: index,
      group: blockMeshGroup,
      texture: texture,
      mesh: cube,
      hidden: true,
      src: textureSrc,
      pair: null,
      matched: false,
    };

    return block;
  }

  function createAllBlocks() {
    for (let i = 0; i < imagesDuplicated.length; i++) {
      const block = createBlock(i);
      blocks.set(i, block);
      gameGroup.appendChild(block.group);
    }
  }

  function resetAllBlocks() {
    if (blocks.size > 0) {
      blocks.forEach((block) => {
        block.texture.remove();
        block.mesh.remove();
        block.group.remove();
      });
    }
    blocks.clear();
    createAllBlocks();
    findPairs();
  }

  function findPairs() {
    blocks.forEach((block, index) => {
      blocks.forEach((otherBlock, otherIndex) => {
        if (index !== otherIndex && block.src === otherBlock.src) {
          block.pair = otherIndex;
        }
      });
    });
  }

  function animate(element, attr, start, end, duration, easing) {
    animating = true;
    const anim = document.createElement("m-attr-anim");
    anim.setAttribute("attr", attr);
    anim.setAttribute("start", start);
    anim.setAttribute("end", end);
    anim.setAttribute("start-time", document.timeline.currentTime);
    anim.setAttribute("end-time", document.timeline.currentTime + duration);
    anim.setAttribute("duration", duration);
    anim.setAttribute("easing", easing);
    anim.setAttribute("loop", false);
    element.appendChild(anim);
    setTimeout(() => {
      element.setAttribute(attr, end);
      element.removeChild(anim);
      animating = false;
    }, duration + 50);
  }

  function revealAllBlocks(revealDuration) {
    blocks.forEach((block, index) => {
      animate(block.group, "ry", 180, 0, animDuration, defaultEasing);
      setTimeout(() => {
        animate(block.group, "ry", 0, 180, animDuration, defaultEasing);
      }, revealDuration);
    });
    isReset = true;
  }

  function hideAllBlocks() {
    blocks.forEach((block, index) => {
      animate(block.mesh, "color", colorMatch, colorOff, animDuration, defaultEasing);
      animate(block.group, "ry", 0, 180, animDuration, defaultEasing);
    });
  }

  function revealBlock(index) {
    const blockObject = blocks.get(index);
    if (blockObject.hidden === false) {
      return;
    }

    animate(blockObject.group, "ry", 180, 0, animDuration, defaultEasing);
    animate(blockObject.mesh, "color", colorOff, colorOn, animDuration, defaultEasing);

    setTimeout(() => {
      blockObject.hidden = false;
      blockObject.mesh.setAttribute("color", colorOn);
    }, animDuration);

    if (firstIndexSelected === null) {
      firstIndexSelected = index;
    } else if (secondIndexSelected === null) {
      secondIndexSelected = index;
      const match = checkForMatch();
    }
  }

  function hideBlock(index) {
    const blockObject = blocks.get(index);
    animate(blockObject.group, "ry", 0, 180, animDuration, defaultEasing);
    animate(blockObject.mesh, "color", colorOn, colorOff, animDuration, defaultEasing);
    setTimeout(() => {
      blockObject.hidden = true;
    }, animDuration);
  }

  function hideBlocks(indexA, indexB) {
    const blockObjectA = blocks.get(indexA);
    const blockObjectB = blocks.get(indexB);
    animate(blockObjectA.group, "ry", 0, 180, animDuration, defaultEasing);
    animate(blockObjectA.mesh, "color", colorOn, colorOff, animDuration, defaultEasing);
    animate(blockObjectB.group, "ry", 0, 180, animDuration, defaultEasing);
    animate(blockObjectB.mesh, "color", colorOn, colorOff, animDuration, defaultEasing);
    setTimeout(() => {
      blockObjectA.hidden = true;
      blockObjectB.hidden = true;
      firstIndexSelected = null;
      secondIndexSelected = null;
    }, animDuration);
  }

  function checkIfGameOver() {
    let matchedBlocks = 0;
    blocks.forEach((block) => {
      if (block.matched === true) {
        matchedBlocks++;
      }
    });
    if (matchedBlocks === numberOfImages * 2) {
      isReseting = true;
      gameInProgress = false;
      setTimeout(() => playWin(), 1000);
      setTimeout(() => hideAllBlocks(), 2000);
      setTimeout(() => reStartGame(), 4000);
    }
  }

  function checkForMatch() {
    if (firstIndexSelected === null || secondIndexSelected === null) {
      return false;
    }
    const firstBlockObject = blocks.get(firstIndexSelected);
    const secondBlockObject = blocks.get(secondIndexSelected);
    if (firstBlockObject.pair === secondBlockObject.id) {
      firstBlockObject.matched = true;
      secondBlockObject.matched = true;
      animate(firstBlockObject.mesh, "color", colorOn, colorMatch, animDuration, defaultEasing);
      animate(secondBlockObject.mesh, "color", colorOn, colorMatch, animDuration, defaultEasing);
      firstIndexSelected = null;
      secondIndexSelected = null;
      playYes();
      checkIfGameOver();
      return true;
    } else {
      playNo();
      setTimeout(() => hideBlocks(firstIndexSelected, secondIndexSelected), 1500);
    }
  }

  function handleBlockClick(index) {
    if (isReseting) {
      return;
    }
    isReset = false;
    gameInProgress = true;
    const bothIndexSelected = firstIndexSelected !== null && secondIndexSelected !== null;
    if (!animating && !bothIndexSelected) {
      const blockObject = blocks.get(index);
      if (blockObject && !blockObject.matched) {
        revealBlock(index);
      }
    }
  }

  function reStartGame() {
    if (isReset === false) {
      prepareImages();
      resetAllBlocks();
      setTimeout(() => revealAllBlocks(4000), 1500);
      setTimeout(() => {
        lastReset = document.timeline.currentTime;
        isReseting = false;
      }, 5500);
    } else {
      revealAllBlocks(4000);
      setTimeout(() => {
        lastReset = document.timeline.currentTime;
        isReseting = false;
      }, 5500);
    }
  }

  function formatTime(ms) {
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);

    const secondsPart = (seconds % 60).toString().padStart(2, "0");
    const minutesPart = (minutes % 60).toString().padStart(2, "0");
    const hoursPart = hours.toString().padStart(2, "0");

    if (hours > 0) {
      return `${hoursPart}h ${minutesPart}m ${secondsPart}s`;
    } else if (minutes > 0) {
      return `${minutesPart}m ${secondsPart}s`;
    } else {
      return `${secondsPart}s`;
    }
  }

  setInterval(() => {
    if (gameInProgress === true && isReseting === false) {
      if (playButton) {
        playButton.setAttribute("content", formatTime(document.timeline.currentTime - lastReset));
      }
    } else {
      if (playButton) {
        if (playButton.getAttribute("content") !== "PLAY") {
          playButton.setAttribute("content", "PLAY");
        }
      }
    }
  }, 1000);

  createFrame();
  createSFX();
  reStartGame();
</script>
