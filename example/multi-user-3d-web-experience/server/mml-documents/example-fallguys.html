<m-group id="fall-guys-group" y="300"></m-group>
<script>
  const fallGuysGroup = document.getElementById("fall-guys-group");
  const usersInRange = new Map();

  const gameYPos = 90;
  const gameZPos = 300;

  function randomIntPoN(val) {
    val = Math.abs(val);
    return Math.floor(Math.random() * (val * 2 + 1)) - val;
  }

  function createCube(
    x,
    y,
    z,
    width,
    height,
    depth,
    opacity,
    color = "#aaaaaa",
    castShadows = true,
  ) {
    const cube = document.createElement("m-cube");
    cube.setAttribute("x", x);
    cube.setAttribute("y", y);
    cube.setAttribute("z", z);
    cube.setAttribute("width", width);
    cube.setAttribute("depth", depth);
    cube.setAttribute("height", height);
    cube.setAttribute("color", color);
    cube.setAttribute("opacity", opacity);
    cube.setAttribute("cast-shadows", castShadows);
    return cube;
  }

  function createCylinder(x, y, z, radius, height, opacity, color = "#aaaaaa") {
    const cube = document.createElement("m-cylinder");
    cube.setAttribute("x", x);
    cube.setAttribute("y", y);
    cube.setAttribute("z", z);
    cube.setAttribute("radius", radius);
    cube.setAttribute("height", height);
    cube.setAttribute("color", color);
    cube.setAttribute("opacity", opacity);
    return cube;
  }

  function animate(element, attr, start, end, duration, easing) {
    const anim = document.createElement("m-attr-anim");
    anim.setAttribute("attr", attr);
    anim.setAttribute("start", start);
    anim.setAttribute("end", end);
    anim.setAttribute("start-time", document.timeline.currentTime);
    anim.setAttribute("end-time", document.timeline.currentTime + duration);
    anim.setAttribute("duration", duration);
    anim.setAttribute("easing", easing);
    anim.setAttribute("loop", false);
    element.appendChild(anim);
    setTimeout(() => {
      element.setAttribute(attr, end);
      element.removeChild(anim);
    }, duration);
    return anim;
  }

  function createSequence(element, sequence, easing, duration, pauses, loop = false) {
    const timeAction = (cb, delay) => setTimeout(() => cb(), delay);

    const animSequence = [];
    for (let i = 0; i < sequence.length; i++) {
      const seq = sequence[i];
      if (Array.isArray(seq)) {
        const subSeqArr = [];
        for (let j = 0; j < seq.length; j++) {
          const subSeq = seq[j];
          subSeqArr.push(() =>
            animate(element, subSeq.attr, subSeq.start, subSeq.end, duration, easing),
          );
        }
        animSequence.push(subSeqArr);
      } else {
        animSequence.push(() =>
          animate(element, sequence[i].attr, sequence[i].start, sequence[i].end, duration, easing),
        );
      }
    }

    const seqSize = animSequence.length;
    const seqDuration = seqSize * duration + seqSize * pauses;

    const playSeq = () => {
      for (let i = 0; i < seqSize; i++) {
        if (typeof animSequence[i] === "function") {
          timeAction(animSequence[i], duration * i + pauses * i);
        } else if (Array.isArray(animSequence[i])) {
          for (let j = 0; j < animSequence[i].length; j++) {
            timeAction(animSequence[i][j], duration * i + pauses * i);
          }
        }
      }
    };

    playSeq();
    if (loop === true) {
      setInterval(() => playSeq(), seqDuration);
    } else {
      setTimeout(() => element.remove() + 100, seqDuration);
    }
  }

  function createTransporter(x, y, z, targetY) {
    const size = 1.25;
    const thickness = 0.03;
    const transporter = createCylinder(x, y, z, size, thickness, 1.0, "#4D96ED");

    const coinFlip = Math.random() < 0.5 ? -1 : 1;

    const firstX = (-10 - Math.random() * 20) * coinFlip;
    const firstY = targetY - 15 + Math.random() * 20;
    const firstZ = -70 + randomIntPoN(10);

    const secondX = Math.random() * 10 * coinFlip;
    const secondY = targetY + 20 + Math.random() * 10;
    const secondZ = -30 + Math.random() * 20;

    const finalX = randomIntPoN(12);
    const finalZ = randomIntPoN(10);

    const transportSequence = [
      [
        { attr: "x", start: x, end: firstX },
        { attr: "y", start: y, end: firstY },
        { attr: "z", start: z, end: firstZ },
      ],
      [
        { attr: "x", start: firstX, end: secondX },
        { attr: "y", start: firstY, end: secondY },
        { attr: "z", start: firstZ, end: secondZ },
      ],
      [
        { attr: "x", start: secondX, end: finalX },
        { attr: "y", start: secondY, end: targetY - thickness },
        { attr: "z", start: secondZ, end: finalZ },
      ],
    ];
    createSequence(transporter, transportSequence, "easeInOutQuart", 1500, 0, false);
    fallGuysGroup.appendChild(transporter);
  }

  function createRespawner(targetY) {
    const respawnerWidth = 295;
    const respawnerHeight = 0.2;
    const respawnerDepth = 900;
    const usersColliding = new Set();
    const respawner = createCube(
      0,
      0,
      0,
      respawnerWidth,
      respawnerHeight,
      respawnerDepth,
      0,
      "#ffffff",
      false,
    );
    respawner.setAttribute("collision-interval", 100);
    respawner.addEventListener("collisionstart", (e) => {
      if (!usersColliding.has(e.detail.connectionId)) {
        usersColliding.add(e.detail.connectionId);
        const { x, y, z } = e.detail.position;
        const worldX = x * respawnerWidth;
        const worldY = y * respawnerHeight - respawnerHeight * 1.9;
        const worldZ = z * respawnerDepth;
        const height = respawnerHeight / 2;
        createTransporter(worldX, worldY, worldZ, targetY);
      }
    });
    respawner.addEventListener("collisionend", (e) => {
      if (usersColliding.has(e.detail.connectionId)) {
        usersColliding.delete(e.detail.connectionId);
      }
    });
    respawner.addEventListener("collisionmove", (e) => {
      if (!usersColliding.has(e.detail.connectionId)) {
        usersColliding.add(e.detail.connectionId);
        const { x, y, z } = e.detail.position;
        const worldX = x * respawnerWidth;
        const worldY = y * respawnerHeight - respawnerHeight * 1.9;
        const worldZ = z * respawnerDepth;
        const height = respawnerHeight / 2;
        createTransporter(worldX, worldY, worldZ);
      }
    });
    window.addEventListener("disconnected", (e) => {
      if (usersColliding.has(e.detail.connectionId)) {
        usersColliding.delete(e.detail.connectionId);
      }
      if (usersInRange.has(e.detail.connectionId)) {
        usersInRange.delete(e.detail.connectionId);
      }
    });

    fallGuysGroup.appendChild(respawner);
  }

  function createStageFrame(url, x, y, z) {
    const frame = document.createElement("m-frame");
    frame.setAttribute("src", url);
    frame.setAttribute("x", x);
    frame.setAttribute("y", y);
    frame.setAttribute("z", z);
    fallGuysGroup.appendChild(frame);
  }

  function createStart(yPos) {
    const start = document.createElement("m-model");
    start.setAttribute("src", "/assets/playground/fg_game_start.glb");
    start.setAttribute("x", 0);
    start.setAttribute("y", yPos);
    start.setAttribute("z", 0);

    let furthestZ = 0;

    const positionProbe = document.createElement("m-position-probe");
    positionProbe.setAttribute("interval", 333);
    positionProbe.setAttribute("range", 300);
    positionProbe.setAttribute("z", 250);
    positionProbe.setAttribute("debug", false);

    const gameMusic = document.createElement("m-audio");
    gameMusic.setAttribute("src", "/assets/playground/kabalevsky.mp3");
    gameMusic.setAttribute("loop", true);
    gameMusic.setAttribute("z", -14);
    gameMusic.setAttribute("y", 3);
    gameMusic.setAttribute("ry", 180);
    gameMusic.setAttribute("cone-angle", 90);
    gameMusic.setAttribute("cone-falloff-angle", 130);
    gameMusic.setAttribute("volume", 3);
    gameMusic.setAttribute("start-time", document.timeline.currentTime);
    gameMusic.setAttribute("debug", false);
    start.appendChild(gameMusic);

    positionProbe.addEventListener("positionenter", (e) => {
      const relativeZ = e.detail.elementRelative.position.z;
      usersInRange.set(e.detail.connectionId, relativeZ);
    });
    positionProbe.addEventListener("positionmove", (e) => {
      const relativeZ = e.detail.elementRelative.position.z;
      usersInRange.set(e.detail.connectionId, relativeZ);
    });
    positionProbe.addEventListener("positionleave", (e) => {
      if (usersInRange.has(e.detail.connectionId)) {
        usersInRange.delete(e.detail.connectionId);
      }
    });

    setInterval(() => {
      let max = -1000;
      usersInRange.forEach((user) => {
        if (user > max) max = user;
      });
      gameMusic.setAttribute("z", max + 260);
    }, 333);

    start.appendChild(positionProbe);
    fallGuysGroup.appendChild(start);
  }

  function createEnd(yPos, zPos) {
    const end = document.createElement("m-model");
    end.setAttribute("src", "/assets/playground/fg_game_end.glb");
    end.setAttribute("x", 0);
    end.setAttribute("y", yPos);
    end.setAttribute("z", zPos);
    fallGuysGroup.appendChild(end);
  }

  createRespawner(gameYPos);

  createStart(gameYPos);
  createStageFrame("wss:///mml-documents/example-fallguys-heli.html", 0, gameYPos, 70);
  createStageFrame("wss:///mml-documents/example-fallguys-heli.html", 0, gameYPos, 140);
  createStageFrame("wss:///mml-documents/example-fallguys-rotate.html", 0, gameYPos, 36.05);
  createStageFrame("wss:///mml-documents/example-fallguys-hammers.html", 0, gameYPos, 98);
  createStageFrame("wss:///mml-documents/example-fallguys-sine.html", 0, gameYPos, 135);
  createStageFrame("wss:///mml-documents/example-fallguys-axe.html", 0, gameYPos, 259);
  createEnd(gameYPos, 296.6);
</script>
